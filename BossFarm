-- Boss Farm Module for Bloodlines
-- Place this file on GitHub and load it remotely

local BossFarm = {}

-- ============================================
-- BOSS FARM SETTINGS
-- ============================================

getgenv().BossFarmSettings = {
    Enabled = false,
    SelectedBoss = "Wooden Golem",
    ServerHopWhenComplete = true,
    RespawnWaitTime = 120 -- seconds to wait for boss respawn
}

-- ============================================
-- BOSS CONFIGURATIONS
-- ============================================

local BOSS_CONFIGS = {
    ["Wooden Golem"] = {
        modelNames = {"Wooden Golem"},
        farmHeight = 15,
        safeHeight = 30,
        dangerousAnimations = {
            ["rbxassetid://120758909308511"] = true,
            ["rbxassetid://116907126244057"] = true
        },
        rewardsFolder = "WoodenGolemRewards",
        minPlayers = 10,
        spawnsInWorkspace = true
    },
    
    ["Chakra Knight"] = {
        modelNames = {"Chakra Knight"},
        farmHeight = 15,
        safeHeight = 25,
        dangerousAnimations = {
            ["rbxassetid://10141233349"] = true
        },
        rewardsFolder = "ChakraKnightRewards",
        minPlayers = 10,
        spawnsInWorkspace = true
    },
    
    ["Tairock"] = {
        modelNames = {"Tairock"},
        farmHeight = 11,
        safeHeight = 30,
        dangerousAnimations = {},
        rewardsFolder = "TairockRewards",
        minPlayers = 10,
        spawnsInWorkspace = true,
    }
}

-- ============================================
-- BOSS ESP
-- ============================================

getgenv().BossESPSettings = {
    Enabled = false,
    Show = {
        Name = true,
        Health = true,
        Distance = true,
    },
    TextSize = 18,
    MaxDistance = 99999
}

getgenv().ActiveBossESP = {}

-- Boss database
local bossDatabase = {
    "Wooden Golem",
    "Chakra Knight",
    "Tairock"
}

local function createBossESP(boss)
    local Drawing = Drawing
    local esp = {
        NameText = Drawing.new("Text"),
        HealthText = Drawing.new("Text")
    }
    
    esp.NameText.Color = Color3.fromRGB(255, 0, 0)
    esp.NameText.Size = getgenv().BossESPSettings.TextSize
    esp.NameText.Outline = true
    esp.NameText.Center = true
    esp.NameText.Visible = false
    
    esp.HealthText.Color = Color3.fromRGB(0, 255, 0)
    esp.HealthText.Size = getgenv().BossESPSettings.TextSize
    esp.HealthText.Outline = true
    esp.HealthText.Center = true
    esp.HealthText.Visible = false

    getgenv().ActiveBossESP[boss] = esp
    return esp
end

local function updateBossESP(boss, esp)
    local RunService = game:GetService("RunService")
    local Camera = workspace.CurrentCamera
    
    local connection
    connection = RunService.RenderStepped:Connect(function()
        local Settings = getgenv().BossESPSettings
        if not Settings.Enabled or not boss or not boss.Parent then
            esp.NameText.Visible = false
            esp.HealthText.Visible = false
            if not boss or not boss.Parent then
                connection:Disconnect()
            end
            return
        end

        local rootPart = boss:FindFirstChild("HumanoidRootPart")
        local humanoid = boss:FindFirstChildOfClass("Humanoid")
        
        if rootPart and rootPart:IsA("BasePart") and humanoid then
            local vector, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
            if onScreen then
                local distance = (Camera.CFrame.Position - rootPart.Position).Magnitude

                if distance <= Settings.MaxDistance then
                    local info = {}
                    if Settings.Show.Name then 
                        table.insert(info, "[" .. boss.Name .. "]") 
                    end
                    if Settings.Show.Distance then
                        table.insert(info, string.format("[%dm]", math.floor(distance)))
                    end

                    esp.NameText.Text = table.concat(info, " ")
                    esp.NameText.Size = Settings.TextSize
                    esp.NameText.Position = Vector2.new(vector.X, vector.Y - 20)
                    esp.NameText.Visible = true
                    
                    if Settings.Show.Health and humanoid.Health > 0 then
                        esp.HealthText.Text = string.format("[%d/%d HP]", math.floor(humanoid.Health), math.floor(humanoid.MaxHealth))
                        esp.HealthText.Size = Settings.TextSize
                        esp.HealthText.Position = Vector2.new(vector.X, vector.Y)
                        esp.HealthText.Visible = true
                    else
                        esp.HealthText.Visible = false
                    end
                else
                    esp.NameText.Visible = false
                    esp.HealthText.Visible = false
                end
            else
                esp.NameText.Visible = false
                esp.HealthText.Visible = false
            end
        else
            esp.NameText.Visible = false
            esp.HealthText.Visible = false
        end
    end)
end

local function onBossAdded(boss)
    if table.find(bossDatabase, boss.Name) and boss:IsA("Model") then
        local humanoid = boss:FindFirstChildOfClass("Humanoid")
        if humanoid then
            local bossESP = createBossESP(boss)
            updateBossESP(boss, bossESP)

            boss.Destroying:Connect(function()
                if getgenv().ActiveBossESP[boss] then
                    for _, item in pairs(getgenv().ActiveBossESP[boss]) do
                        if item.Remove then item:Remove() end
                    end
                    getgenv().ActiveBossESP[boss] = nil
                end
            end)
        end
    end
end

-- Scan existing bosses
for _, child in pairs(workspace:GetChildren()) do
    if table.find(bossDatabase, child.Name) then
        task.spawn(onBossAdded, child)
    end
end

-- Monitor for new bosses
workspace.ChildAdded:Connect(function(child)
    if table.find(bossDatabase, child.Name) then
        onBossAdded(child)
    end
end)

-- ============================================
-- BOSS FARM CORE LOGIC
-- ============================================

local bossFarmThread
local bossFarmRunning = false
local currentBossTarget = nil
local bossFarmConnections = {}
local lastKnownBossPosition = nil
local animationTracker = {}

-- Safe spot position
local SAFE_SPOT = Vector3.new(-2950.580, 321.173, -275.704)

-- Required dependencies (passed from main script)
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local dataEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("DataEvent")

-- Get inDanger state from main script
local function getInDanger()
    return getgenv().inDanger or false
end

-- Helper function to get player data
local function getPlayerData()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    return {
        character = character,
        rootPart = character:FindFirstChild("HumanoidRootPart"),
        humanoid = character:FindFirstChildOfClass("Humanoid")
    }
end

-- Function to constantly teleport player to safe spot
local function constantTeleportToSafeSpot()
    local playerData = getPlayerData()
    local rootPart = playerData and playerData.rootPart
    if not rootPart then return end
    
    print("[Boss Farm] Starting constant teleport to safe spot...")
    if _G.NotificationLib then
        _G.NotificationLib:MakeNotification({
            Title = "Boss Farm",
            Text = "Teleporting to safe spot...",
            Duration = 3
        })
    end
    
    local safeSpotConnection = RunService.Heartbeat:Connect(function()
        if rootPart and rootPart.Parent then
            rootPart.CFrame = CFrame.new(SAFE_SPOT)
        end
    end)
    
    return safeSpotConnection
end

-- Function to server hop with retry logic
local function performServerHop()
    print("[Boss Farm] Initiating server hop...")
    
    -- Check if player is in danger and wait until safe
    if getInDanger() then
        print("[Boss Farm] Player is in combat! Teleporting to safe spot and waiting...")
        if _G.NotificationLib then
            _G.NotificationLib:MakeNotification({
                Title = "Boss Farm",
                Text = "In combat! Going to safe spot...",
                Duration = 3
            })
        end
        
        -- Teleport to safe spot immediately
        local playerData = getPlayerData()
        local rootPart = playerData and playerData.rootPart
        if rootPart then
            rootPart.CFrame = CFrame.new(SAFE_SPOT)
        end
        
        -- Wait until out of danger
        while getInDanger() do
            wait(0.5)
            print("[Boss Farm] Still in combat, waiting...")
        end
        
        print("[Boss Farm] Out of combat! Proceeding with server hop...")
        if _G.NotificationLib then
            _G.NotificationLib:MakeNotification({
                Title = "Boss Farm",
                Text = "Out of combat! Server hopping now...",
                Duration = 3
            })
        end
        
        wait(1)
    end
    
    local maxAttempts = 5
    local currentAttempt = 0
    
    while currentAttempt < maxAttempts do
        currentAttempt = currentAttempt + 1
        print(string.format("[Boss Farm] Server hop attempt %d/%d", currentAttempt, maxAttempts))
        
        local success, err = pcall(function()
            local playerGui = LocalPlayer:WaitForChild("PlayerGui", 5)
            local clientGui = playerGui:WaitForChild("ClientGui", 5)
            
            local list
            local mainframe = clientGui:FindFirstChild("Mainframe")
            
            if mainframe then
                local rest = mainframe:FindFirstChild("Rest")
                if rest then
                    local serverList = rest:FindFirstChild("ServerList")
                    if serverList then
                        local backdrop = serverList:FindFirstChild("BackDrop")
                        if backdrop then
                            list = backdrop:FindFirstChild("List")
                        end
                    end
                end
            end
            
            if not list or #list:GetChildren() == 0 then
                local menuScreen = clientGui:FindFirstChild("MenuScreen")
                if menuScreen then
                    local serverList = menuScreen:FindFirstChild("ServerList")
                    if serverList then
                        local backdrop = serverList:FindFirstChild("BackDrop")
                        if backdrop then
                            list = backdrop:FindFirstChild("List")
                        end
                    end
                end
            end
            
            if not list then return end
            
            local validServers = {}
            
            for _, frame in ipairs(list:GetChildren()) do
                if frame:IsA("Frame") and frame.Name == "ServerTemplate" then
                    local playersLabel = frame:FindFirstChild("Players")
                    local joinButton = frame:FindFirstChild("JoinButton")
                    
                    if playersLabel and joinButton and joinButton:IsA("TextButton") then
                        local playerText = playersLabel.Text
                        local playerCount = tonumber(playerText:match("%d+"))
                        
                        if playerCount and playerCount >= 10 then
                            table.insert(validServers, {
                                frame = frame,
                                button = joinButton,
                                playerCount = playerCount
                            })
                        end
                    end
                end
            end
            
            if #validServers == 0 then 
                print("[Boss Farm] No valid servers found")
                return 
            end
            
            local randomIndex = math.random(1, #validServers)
            local selectedServer = validServers[randomIndex]
            
            print(string.format("[Boss Farm] Attempting to join server with %d players...", selectedServer.playerCount))
            
            pcall(function()
                for _, connection in pairs(getconnections(selectedServer.button.MouseButton1Click)) do
                    connection:Fire()
                end
            end)
        end)
        
        if not success then
            warn("[Boss Farm] Server hop attempt failed:", err)
        end
        
        wait(2)
        
        if currentAttempt < maxAttempts then
            print("[Boss Farm] Server likely full, retrying with different server...")
            if _G.NotificationLib then
                _G.NotificationLib:MakeNotification({
                    Title = "Boss Farm",
                    Text = string.format("Server full! Retry %d/%d", currentAttempt + 1, maxAttempts),
                    Duration = 2
                })
            end
        else
            print("[Boss Farm] Max server hop attempts reached")
            if _G.NotificationLib then
                _G.NotificationLib:MakeNotification({
                    Title = "Boss Farm",
                    Text = "Failed to find available server after 5 attempts",
                    Duration = 3
                })
            end
        end
    end
end

-- Function to check if any player is within distance of boss
local function isPlayerNearBoss(boss, maxDistance)
    local rootPart = boss:FindFirstChild("HumanoidRootPart")
    if not rootPart then return false end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local character = player.Character
            if character then
                local playerRoot = character:FindFirstChild("HumanoidRootPart")
                if playerRoot then
                    local distance = (playerRoot.Position - rootPart.Position).Magnitude
                    if distance <= maxDistance then
                        return true, player.Name, distance
                    end
                end
            end
        end
    end
    return false
end

-- Function to find boss by name
local function findBoss(bossName)
    for _, child in pairs(workspace:GetChildren()) do
        if child.Name == bossName and child:IsA("Model") then
            local humanoid = child:FindFirstChildOfClass("Humanoid")
            local rootPart = child:FindFirstChild("HumanoidRootPart")
            if humanoid and rootPart and humanoid.Health > 0 then
                return child
            end
        end
    end
    return nil
end

-- Function to check if boss is playing dangerous animation
local function isDangerousAnimation(boss, bossConfig)
    if not bossConfig.dangerousAnimations then return false end
    
    local humanoid = boss:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then return false end
    
    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
        local animId = track.Animation.AnimationId
        if bossConfig.dangerousAnimations[animId] then
            return true, animId
        end
    end
    
    return false
end

-- Function to setup animation tracking for boss
local function setupAnimationTracking(boss, bossConfig)
    local humanoid = boss:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then return end
    
    -- Track when animations start
    local animationConnection = animator.AnimationPlayed:Connect(function(track)
        local animId = track.Animation.AnimationId
        if bossConfig.dangerousAnimations[animId] then
            print("[Boss Farm] Dangerous animation detected:", animId)
            animationTracker[boss] = {
                dangerous = true,
                animId = animId,
                track = track
            }
            
            -- When animation stops, mark as safe again
            track.Stopped:Connect(function()
                print("[Boss Farm] Dangerous animation ended:", animId)
                if animationTracker[boss] then
                    animationTracker[boss].dangerous = false
                end
            end)
        end
    end)
    
    table.insert(bossFarmConnections, animationConnection)
end

-- Function to farm boss
local function farmBoss(boss, healthThresholdType)
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    local humanoid = character:WaitForChild("Humanoid")
    
    local bossRoot = boss:FindFirstChild("HumanoidRootPart")
    local bossHumanoid = boss:FindFirstChildOfClass("Humanoid")
    if not bossRoot or not bossHumanoid then return false, healthThresholdType end
    
    -- Get boss config
    local bossConfig = BOSS_CONFIGS[boss.Name]
    if not bossConfig then 
        warn("[Boss Farm] No config found for boss:", boss.Name)
        return false, healthThresholdType 
    end
    
    currentBossTarget = boss.Name
    lastKnownBossPosition = bossRoot.Position
    
    -- Setup animation tracking
    setupAnimationTracking(boss, bossConfig)
    
    local healthThreshold
    if healthThresholdType == "max" then
        healthThreshold = humanoid.MaxHealth * 0.5
        print(string.format("[Boss Farm] Health threshold: 50%% of Max HP (%.1f)", healthThreshold))
    else
        healthThreshold = humanoid.Health * 0.5
        print(string.format("[Boss Farm] Health threshold: 50%% of Current HP (%.1f)", healthThreshold))
    end
    
    print("[Boss Farm] Farming " .. boss.Name .. "...")
    if _G.NotificationLib then
        _G.NotificationLib:MakeNotification({
            Title = "Boss Farm",
            Text = "Farming " .. boss.Name .. "...",
            Duration = 3
        })
    end

    -- Attack thread
    local attackThread = task.spawn(function()
        while bossFarmRunning and currentBossTarget == boss.Name do
            wait(0.7)

            if bossFarmRunning and currentBossTarget == boss.Name then
                pcall(function()
                    dataEvent:FireServer("CheckMeleeHit", nil, "NormalAttack", false)
                end)
            end
        end
    end)
    
    -- Enable noclip
    local noclipConnection = RunService.Stepped:Connect(function()
        if bossFarmRunning and getgenv().BossFarmSettings.Enabled then
            for _, part in pairs(character:GetDescendants()) do
                if part:IsA('BasePart') then
                    part.CanCollide = false
                end
            end
        end
    end)
    table.insert(bossFarmConnections, noclipConnection)
    
    -- Continuous teleport loop (ABOVE BOSS, with animation-based positioning)
    local teleportConnection = RunService.Heartbeat:Connect(function()
        if bossFarmRunning and getgenv().BossFarmSettings.Enabled then
            if humanoidRootPart then
                if bossRoot and bossRoot.Parent then
                    lastKnownBossPosition = bossRoot.Position
                end
                
                -- Check if boss is playing dangerous animation
                local isDangerous = isDangerousAnimation(boss, bossConfig)
                local heightToUse = isDangerous and bossConfig.safeHeight or bossConfig.farmHeight
                
                -- Farm ABOVE the boss (positive Y offset)
                local farmPosition = lastKnownBossPosition + Vector3.new(0, heightToUse, 0)
                local lookAtBoss = CFrame.new(farmPosition, lastKnownBossPosition)
                humanoidRootPart.CFrame = lookAtBoss
            end
        end
    end)
    table.insert(bossFarmConnections, teleportConnection)
    
    -- Main farming loop
    local bossDefeated = false
    local lowHealthExit = false
    
    while bossFarmRunning and currentBossTarget == boss.Name do
        -- Health check
        if humanoid.Health < healthThreshold and not lowHealthExit then
            print(string.format("[Boss Farm] Health below threshold! (%.1f < %.1f)", humanoid.Health, healthThreshold))
            
            lowHealthExit = true
            healthThresholdType = "current"
            
            if teleportConnection then
                teleportConnection:Disconnect()
                teleportConnection = nil
            end
            
            local safeSpotConnection = constantTeleportToSafeSpot()
            table.insert(bossFarmConnections, safeSpotConnection)
            
            wait(2)
            break
        end
        
        if not bossDefeated then
            if not boss.Parent or not bossRoot.Parent or bossHumanoid.Health <= 0 then
                print("[Boss Farm] Boss defeated!")
                if _G.NotificationLib then
                    _G.NotificationLib:MakeNotification({
                        Title = "Boss Farm",
                        Text = boss.Name .. " defeated!",
                        Duration = 3
                    })
                end
                bossDefeated = true
                break
            end
            
            if math.random(1, 10) == 1 then
                local playerNearby, playerName, distance = isPlayerNearBoss(boss, 100)
                if playerNearby then
                    print(string.format("[Boss Farm] Player %s detected within %.1fm!", playerName, distance))
                    
                    if teleportConnection then
                        teleportConnection:Disconnect()
                        teleportConnection = nil
                    end
                    
                    local safeSpotConnection = constantTeleportToSafeSpot()
                    table.insert(bossFarmConnections, safeSpotConnection)
                    
                    wait(2)
                    break
                end
            end
        end
        
        RunService.Heartbeat:Wait()
    end
    
    if attackThread then
        task.cancel(attackThread)
    end
    
    -- Clean up animation tracker
    animationTracker[boss] = nil
    
    print("[Boss Farm] Exiting farm loop for this boss")
    
    return true, healthThresholdType
end

-- Main Boss farm loop
local function startBossFarm()
    if bossFarmRunning then return end
    
    bossFarmThread = task.spawn(function()
        bossFarmRunning = true
        
        if _G.NotificationLib then
            _G.NotificationLib:MakeNotification({
                Title = "Boss Farm",
                Text = "Boss auto-farm started!",
                Duration = 3
            })
        end
        
        local healthThresholdType = "max"
        
        while getgenv().BossFarmSettings.Enabled do
            for _, connection in pairs(bossFarmConnections) do
                if connection and connection.Connected then
                    pcall(function()
                        connection:Disconnect()
                    end)
                end
            end
            bossFarmConnections = {}
            
            local selectedBoss = getgenv().BossFarmSettings.SelectedBoss
            local boss = findBoss(selectedBoss)
            
            if not boss then
                print("[Boss Farm] Boss not found, waiting for respawn...")
                if _G.NotificationLib then
                    _G.NotificationLib:MakeNotification({
                        Title = "Boss Farm",
                        Text = "Waiting for " .. selectedBoss .. " to respawn...",
                        Duration = 3
                    })
                end
                
                local waitStartTime = tick()
                local respawnWaitTime = getgenv().BossFarmSettings.RespawnWaitTime
                
                while not boss and (tick() - waitStartTime) < respawnWaitTime do
                    if not getgenv().BossFarmSettings.Enabled then break end
                    
                    wait(2)
                    boss = findBoss(selectedBoss)
                end
                
                if not boss then
                    print("[Boss Farm] Boss did not respawn in time!")
                    if _G.NotificationLib then
                        _G.NotificationLib:MakeNotification({
                            Title = "Boss Farm",
                            Text = selectedBoss .. " did not respawn!",
                            Duration = 3
                        })
                    end
                    
                    if getInDanger() then
                        print("[Boss Farm] Player in danger! Waiting to be safe before server hop...")
                        
                        while getInDanger() do
                            wait(0.5)
                        end
                    end
                    
                    print("[Boss Farm] Moving to safe spot before server hop...")
                    local playerData = getPlayerData()
                    local rootPart = playerData and playerData.rootPart
                    if rootPart then
                        rootPart.CFrame = CFrame.new(SAFE_SPOT)
                    end
                    
                    wait(0.5)
                    
                    if getgenv().BossFarmSettings.ServerHopWhenComplete then
                        performServerHop()
                        break
                    else
                        print("[Boss Farm] Server hop disabled, stopping farm...")
                        break
                    end
                end
            end
            
            if boss then
                local playerNearby, playerName = isPlayerNearBoss(boss, 100)
                if playerNearby then
                    print(string.format("[Boss Farm] Player %s nearby boss, waiting...", playerName))
                    wait(5)
                    continue
                end
                
                local farmSuccess, newThresholdType = farmBoss(boss, healthThresholdType)
                healthThresholdType = newThresholdType or healthThresholdType
                wait(0.3)
            end
        end
        
        bossFarmRunning = false
        currentBossTarget = nil
    end)
end

-- Function to stop Boss farm
local function stopBossFarm()
    bossFarmRunning = false
    currentBossTarget = nil
    animationTracker = {}
    
    for _, connection in pairs(bossFarmConnections) do
        if connection and connection.Connected then
            pcall(function()
                connection:Disconnect()
            end)
        end
    end
    bossFarmConnections = {}
    
    if bossFarmThread then
        pcall(function()
            task.cancel(bossFarmThread)
        end)
        bossFarmThread = nil
    end
end

-- Function to get current farm status
local function getFarmStatus()
    return {
        running = bossFarmRunning,
        currentTarget = currentBossTarget
    }
end

-- Export functions
BossFarm.startFarm = startBossFarm
BossFarm.stopFarm = stopBossFarm
BossFarm.getFarmStatus = getFarmStatus
BossFarm.bossDatabase = bossDatabase
BossFarm.BOSS_CONFIGS = BOSS_CONFIGS

return BossFarm
